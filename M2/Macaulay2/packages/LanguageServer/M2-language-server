#!/bin/sh

set -e

TEMP=$(getopt -o 'vp:h'               \
	      -l 'verbose,port,help'  \
	      -n "M2-language-server" \
	      -- "$@")

if [ $? -ne 0 ]; then
        echo 'Terminating...' >&2
        exit 1
fi

eval set -- "$TEMP"
unset TEMP

debug_level=0

while true; do
    case "$1" in
        '-v'|'--verbose')
	    debug_level=1
	    shift
	    continue
	    ;;
	'-p'|'--port')
	    port=$2
	    shift 2
	    continue
	    ;;
	'-h'|'--help')
	    echo "M2-language-server"
	    echo "options":
	    echo "  -v, --verbose"
	    echo "    verbose output"
	    echo "  -p, --port <port>"
	    echo "    create a TCP server on localhost using <port>"
	    echo "  -h, --help"
	    echo "    this help message"
	    exit 0
	    ;;
	'--')
	    shift
	    break
	    ;;
	*)
	    echo 'Internal error!' >&2
	    exit 1
	    ;;
    esac
done


M2 --silent --srcdir ~/src/macaulay2/M2/M2 \
   -e 'needsPackage "LanguageServer"'      \
   -e "debugLevel = ${debug_level}"        \
   -e "runLanguageServer(${port})"
